#include "nhd_0216k1z.h"
#include <algorithm>
#include <cstring>
#include <cstdio>

// Table 4: Correspondence between Character Codes and Character Patters (A00 ROM)
const u8 nhd_0216k1z::CGROM_A00[256][8] = {
    // --- COLUMN 0 (0x00 - 0x0F) : CGRAM & Reserved ---
    // 0x00 - 0x07 map to CGRAM (User Defined) in hardware. 
    // We leave them zero here; the renderer handles the redirection.
    [0x00] = {0,0,0,0,0,0,0,0}, [0x01] = {0,0,0,0,0,0,0,0}, 
    [0x02] = {0,0,0,0,0,0,0,0}, [0x03] = {0,0,0,0,0,0,0,0},
    [0x04] = {0,0,0,0,0,0,0,0}, [0x05] = {0,0,0,0,0,0,0,0}, 
    [0x06] = {0,0,0,0,0,0,0,0}, [0x07] = {0,0,0,0,0,0,0,0},
    // 0x08 - 0x0F are also CGRAM mirrors or blank in A00
    [0x08] = {0,0,0,0,0,0,0,0}, [0x09] = {0,0,0,0,0,0,0,0}, 
    [0x0A] = {0,0,0,0,0,0,0,0}, [0x0B] = {0,0,0,0,0,0,0,0},
    [0x0C] = {0,0,0,0,0,0,0,0}, [0x0D] = {0,0,0,0,0,0,0,0}, 
    [0x0E] = {0,0,0,0,0,0,0,0}, [0x0F] = {0,0,0,0,0,0,0,0},

    // --- COLUMN 1 (0x10 - 0x1F) : Blank / Undefined in A00 ---
    [0x10] = {0,0,0,0,0,0,0,0}, [0x11] = {0,0,0,0,0,0,0,0}, 
    [0x12] = {0,0,0,0,0,0,0,0}, [0x13] = {0,0,0,0,0,0,0,0},
    [0x14] = {0,0,0,0,0,0,0,0}, [0x15] = {0,0,0,0,0,0,0,0}, 
    [0x16] = {0,0,0,0,0,0,0,0}, [0x17] = {0,0,0,0,0,0,0,0},
    [0x18] = {0,0,0,0,0,0,0,0}, [0x19] = {0,0,0,0,0,0,0,0}, 
    [0x1A] = {0,0,0,0,0,0,0,0}, [0x1B] = {0,0,0,0,0,0,0,0},
    [0x1C] = {0,0,0,0,0,0,0,0}, [0x1D] = {0,0,0,0,0,0,0,0}, 
    [0x1E] = {0,0,0,0,0,0,0,0}, [0x1F] = {0,0,0,0,0,0,0,0},

    // --- COLUMN 2 (0x20 - 0x2F) : ASCII Punctuation & Numbers ---
    [0x20] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Space
    [0x21] = {0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00}, // !
    [0x22] = {0x0A, 0x0A, 0x0A, 0x00, 0x00, 0x00, 0x00, 0x00}, // "
    [0x23] = {0x0A, 0x0A, 0x1F, 0x0A, 0x1F, 0x0A, 0x0A, 0x00}, // #
    [0x24] = {0x04, 0x0F, 0x14, 0x0E, 0x05, 0x1E, 0x04, 0x00}, // $
    [0x25] = {0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03, 0x00}, // %
    [0x26] = {0x0C, 0x12, 0x12, 0x0C, 0x15, 0x12, 0x0D, 0x00}, // &
    [0x27] = {0x0C, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00}, // '
    [0x28] = {0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02, 0x00}, // (
    [0x29] = {0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08, 0x00}, // )
    [0x2A] = {0x00, 0x04, 0x15, 0x0E, 0x15, 0x04, 0x00, 0x00}, // *
    [0x2B] = {0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00, 0x00}, // +
    [0x2C] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x04, 0x08}, // ,
    [0x2D] = {0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x00}, // -
    [0x2E] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // .
    [0x2F] = {0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x00, 0x00}, // /

    // --- COLUMN 3 (0x30 - 0x3F) : Numbers & Symbols ---
    [0x30] = {0x0E, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0E, 0x00}, // 0
    [0x31] = {0x04, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00}, // 1
    [0x32] = {0x0E, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1F, 0x00}, // 2
    [0x33] = {0x1F, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0E, 0x00}, // 3
    [0x34] = {0x02, 0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02, 0x00}, // 4
    [0x35] = {0x1F, 0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E, 0x00}, // 5
    [0x36] = {0x06, 0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E, 0x00}, // 6
    [0x37] = {0x1F, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08, 0x00}, // 7
    [0x38] = {0x0E, 0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E, 0x00}, // 8
    [0x39] = {0x0E, 0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C, 0x00}, // 9
    [0x3A] = {0x00, 0x0C, 0x0C, 0x00, 0x0C, 0x0C, 0x00, 0x00}, // :
    [0x3B] = {0x00, 0x0C, 0x0C, 0x00, 0x0C, 0x04, 0x08, 0x00}, // ;
    [0x3C] = {0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00}, // <
    [0x3D] = {0x00, 0x00, 0x1F, 0x00, 0x1F, 0x00, 0x00, 0x00}, // =
    [0x3E] = {0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08, 0x00}, // >
    [0x3F] = {0x0E, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04, 0x00}, // ?

    // --- COLUMN 4 (0x40 - 0x4F) : Uppercase A-O ---
    [0x40] = {0x0E, 0x11, 0x17, 0x15, 0x1D, 0x10, 0x0E, 0x00}, // @
    [0x41] = {0x04, 0x0A, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x00}, // A
    [0x42] = {0x1E, 0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E, 0x00}, // B
    [0x43] = {0x0E, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0E, 0x00}, // C
    [0x44] = {0x1C, 0x12, 0x11, 0x11, 0x11, 0x12, 0x1C, 0x00}, // D
    [0x45] = {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F, 0x00}, // E
    [0x46] = {0x1F, 0x10, 0x10, 0x1E, 0x10, 0x10, 0x10, 0x00}, // F
    [0x47] = {0x0E, 0x11, 0x10, 0x13, 0x11, 0x11, 0x0F, 0x00}, // G
    [0x48] = {0x11, 0x11, 0x11, 0x1F, 0x11, 0x11, 0x11, 0x00}, // H
    [0x49] = {0x0E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00}, // I
    [0x4A] = {0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0C, 0x00}, // J
    [0x4B] = {0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11, 0x00}, // K
    [0x4C] = {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1F, 0x00}, // L
    [0x4D] = {0x11, 0x1B, 0x15, 0x15, 0x11, 0x11, 0x11, 0x00}, // M
    [0x4E] = {0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x00}, // N
    [0x4F] = {0x0E, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00}, // O

    // --- COLUMN 5 (0x50 - 0x5F) : Uppercase P-Z & Symbols ---
    [0x50] = {0x1E, 0x11, 0x11, 0x1E, 0x10, 0x10, 0x10, 0x00}, // P
    [0x51] = {0x0E, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0D, 0x00}, // Q
    [0x52] = {0x1E, 0x11, 0x11, 0x1E, 0x14, 0x12, 0x11, 0x00}, // R
    [0x53] = {0x0F, 0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E, 0x00}, // S
    [0x54] = {0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00}, // T
    [0x55] = {0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00}, // U
    [0x56] = {0x11, 0x11, 0x11, 0x11, 0x11, 0x0A, 0x04, 0x00}, // V
    [0x57] = {0x11, 0x11, 0x11, 0x15, 0x15, 0x1B, 0x11, 0x00}, // W
    [0x58] = {0x11, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11, 0x00}, // X
    [0x59] = {0x11, 0x11, 0x0A, 0x04, 0x04, 0x04, 0x04, 0x00}, // Y
    [0x5A] = {0x1F, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1F, 0x00}, // Z
    [0x5B] = {0x0E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00}, // [
    [0x5C] = {0x11, 0x11, 0x0A, 0x1F, 0x04, 0x1F, 0x04, 0x00}, // Yen (¥) - Standard in A00
    [0x5D] = {0x0E, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0E, 0x00}, // ]
    [0x5E] = {0x04, 0x0A, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00}, // ^
    [0x5F] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x00}, // _

    // --- COLUMN 6 (0x60 - 0x6F) : Lowercase a-o ---
    [0x60] = {0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00}, // `
    [0x61] = {0x00, 0x00, 0x0E, 0x01, 0x0F, 0x11, 0x0F, 0x00}, // a
    [0x62] = {0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x1E, 0x00}, // b
    [0x63] = {0x00, 0x00, 0x0E, 0x10, 0x10, 0x11, 0x0E, 0x00}, // c
    [0x64] = {0x01, 0x01, 0x0D, 0x13, 0x11, 0x11, 0x0F, 0x00}, // d
    [0x65] = {0x00, 0x00, 0x0E, 0x11, 0x1F, 0x10, 0x0E, 0x00}, // e
    [0x66] = {0x06, 0x09, 0x08, 0x1C, 0x08, 0x08, 0x08, 0x00}, // f
    [0x67] = {0x00, 0x0F, 0x11, 0x11, 0x0F, 0x01, 0x0E, 0x00}, // g
    [0x68] = {0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00}, // h
    [0x69] = {0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x0E, 0x00}, // i
    [0x6A] = {0x02, 0x00, 0x06, 0x02, 0x02, 0x12, 0x0C, 0x00}, // j
    [0x6B] = {0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00}, // k
    [0x6C] = {0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0E, 0x00}, // l
    [0x6D] = {0x00, 0x00, 0x1A, 0x15, 0x15, 0x11, 0x11, 0x00}, // m
    [0x6E] = {0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00}, // n
    [0x6F] = {0x00, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E, 0x00}, // o

    // --- COLUMN 7 (0x70 - 0x7F) : Lowercase p-z & Symbols ---
    [0x70] = {0x00, 0x00, 0x1E, 0x11, 0x1E, 0x10, 0x10, 0x00}, // p
    [0x71] = {0x00, 0x00, 0x0D, 0x13, 0x0F, 0x01, 0x01, 0x00}, // q
    [0x72] = {0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10, 0x00}, // r
    [0x73] = {0x00, 0x00, 0x0F, 0x10, 0x0E, 0x01, 0x1E, 0x00}, // s
    [0x74] = {0x08, 0x08, 0x1C, 0x08, 0x08, 0x09, 0x06, 0x00}, // t
    [0x75] = {0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0D, 0x00}, // u
    [0x76] = {0x00, 0x00, 0x11, 0x11, 0x11, 0x0A, 0x04, 0x00}, // v
    [0x77] = {0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0A, 0x00}, // w
    [0x78] = {0x00, 0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x00}, // x
    [0x79] = {0x00, 0x00, 0x11, 0x11, 0x0F, 0x01, 0x0E, 0x00}, // y
    [0x7A] = {0x00, 0x00, 0x1F, 0x02, 0x04, 0x08, 0x1F, 0x00}, // z
    [0x7B] = {0x02, 0x04, 0x04, 0x08, 0x04, 0x04, 0x02, 0x00}, // {
    [0x7C] = {0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00}, // |
    [0x7D] = {0x08, 0x04, 0x04, 0x02, 0x04, 0x04, 0x08, 0x00}, // }
    [0x7E] = {0x00, 0x04, 0x02, 0x1F, 0x02, 0x04, 0x00, 0x00}, // -> (Right Arrow)
    [0x7F] = {0x00, 0x04, 0x08, 0x1F, 0x08, 0x04, 0x00, 0x00}, // <- (Left Arrow)

    // --- COLUMN 8 & 9 (0x80 - 0x9F) : Blank / Undefined in A00 ---
    [0x80] = {0,0,0,0,0,0,0,0}, [0x81] = {0,0,0,0,0,0,0,0},
    [0x82] = {0,0,0,0,0,0,0,0}, [0x83] = {0,0,0,0,0,0,0,0},
    [0x84] = {0,0,0,0,0,0,0,0}, [0x85] = {0,0,0,0,0,0,0,0},
    [0x86] = {0,0,0,0,0,0,0,0}, [0x87] = {0,0,0,0,0,0,0,0},
    [0x88] = {0,0,0,0,0,0,0,0}, [0x89] = {0,0,0,0,0,0,0,0},
    [0x8A] = {0,0,0,0,0,0,0,0}, [0x8B] = {0,0,0,0,0,0,0,0},
    [0x8C] = {0,0,0,0,0,0,0,0}, [0x8D] = {0,0,0,0,0,0,0,0},
    [0x8E] = {0,0,0,0,0,0,0,0}, [0x8F] = {0,0,0,0,0,0,0,0},
    [0x90] = {0,0,0,0,0,0,0,0}, [0x91] = {0,0,0,0,0,0,0,0},
    [0x92] = {0,0,0,0,0,0,0,0}, [0x93] = {0,0,0,0,0,0,0,0},
    [0x94] = {0,0,0,0,0,0,0,0}, [0x95] = {0,0,0,0,0,0,0,0},
    [0x96] = {0,0,0,0,0,0,0,0}, [0x97] = {0,0,0,0,0,0,0,0},
    [0x98] = {0,0,0,0,0,0,0,0}, [0x99] = {0,0,0,0,0,0,0,0},
    [0x9A] = {0,0,0,0,0,0,0,0}, [0x9B] = {0,0,0,0,0,0,0,0},
    [0x9C] = {0,0,0,0,0,0,0,0}, [0x9D] = {0,0,0,0,0,0,0,0},
    [0x9E] = {0,0,0,0,0,0,0,0}, [0x9F] = {0,0,0,0,0,0,0,0},

    // --- COLUMN 10 (0xA0 - 0xAF) : Japanese Punctuation & Katakana Start ---
    [0xA0] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Nbsp / Space
    [0xA1] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x00}, // ｡ (Handakuten/Period)
    [0xA2] = {0x00, 0x0C, 0x12, 0x12, 0x12, 0x0C, 0x00, 0x00}, // ｢ (Open corner bracket)
    [0xA3] = {0x00, 0x0C, 0x12, 0x12, 0x12, 0x0C, 0x00, 0x00}, // ｣ (Close corner bracket) - Visually similar in 5x7 but usually rotated
    [0xA4] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x10, 0x00}, // ､ (Comma)
    [0xA5] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00}, // ･ (Middle Dot)
    [0xA6] = {0x00, 0x00, 0x11, 0x1F, 0x11, 0x1F, 0x11, 0x00}, // ｦ (Wo)
    [0xA7] = {0x00, 0x04, 0x0E, 0x15, 0x04, 0x04, 0x04, 0x00}, // ｧ (Small A)
    [0xA8] = {0x00, 0x02, 0x0C, 0x02, 0x02, 0x02, 0x00, 0x00}, // ｨ (Small I)
    [0xA9] = {0x00, 0x04, 0x0C, 0x04, 0x04, 0x0C, 0x00, 0x00}, // ｩ (Small U)
    [0xAA] = {0x00, 0x0E, 0x11, 0x0E, 0x08, 0x08, 0x00, 0x00}, // ｪ (Small E)
    [0xAB] = {0x00, 0x0A, 0x0A, 0x0A, 0x0A, 0x04, 0x00, 0x00}, // ｫ (Small O)
    [0xAC] = {0x00, 0x18, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00}, // ｬ (Small Ya)
    [0xAD] = {0x00, 0x00, 0x12, 0x12, 0x12, 0x1C, 0x00, 0x00}, // ｭ (Small Yu)
    [0xAE] = {0x00, 0x0E, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00}, // ｮ (Small Yo)
    [0xAF] = {0x00, 0x04, 0x15, 0x0E, 0x04, 0x04, 0x00, 0x00}, // ｯ (Small Tsu)

    // --- COLUMN 11 (0xB0 - 0xBF) : Katakana ---
    [0xB0] = {0x00, 0x04, 0x04, 0x1F, 0x04, 0x04, 0x00, 0x00}, // ｰ (ProLong)
    [0xB1] = {0x00, 0x04, 0x0E, 0x15, 0x04, 0x04, 0x04, 0x00}, // ｱ (A)
    [0xB2] = {0x00, 0x02, 0x0C, 0x02, 0x02, 0x02, 0x00, 0x00}, // ｲ (I)
    [0xB3] = {0x00, 0x04, 0x0C, 0x04, 0x04, 0x0C, 0x00, 0x00}, // ｳ (U)
    [0xB4] = {0x00, 0x0E, 0x11, 0x0E, 0x08, 0x08, 0x00, 0x00}, // ｴ (E)
    [0xB5] = {0x00, 0x0A, 0x0A, 0x0A, 0x0A, 0x04, 0x00, 0x00}, // ｵ (O)
    [0xB6] = {0x00, 0x06, 0x09, 0x09, 0x06, 0x00, 0x00, 0x00}, // ｶ (Ka)
    [0xB7] = {0x00, 0x09, 0x09, 0x1E, 0x08, 0x18, 0x00, 0x00}, // ｷ (Ki)
    [0xB8] = {0x00, 0x02, 0x0A, 0x06, 0x0A, 0x12, 0x00, 0x00}, // ｸ (Ku)
    [0xB9] = {0x00, 0x02, 0x12, 0x12, 0x12, 0x0C, 0x00, 0x00}, // ｹ (Ke)
    [0xBA] = {0x00, 0x0E, 0x02, 0x02, 0x02, 0x0E, 0x00, 0x00}, // ｺ (Ko)
    [0xBB] = {0x00, 0x12, 0x12, 0x12, 0x12, 0x0C, 0x00, 0x00}, // ｻ (Sa)
    [0xBC] = {0x00, 0x04, 0x0A, 0x0A, 0x0A, 0x11, 0x00, 0x00}, // ｼ (Shi)
    [0xBD] = {0x00, 0x1F, 0x02, 0x04, 0x08, 0x10, 0x00, 0x00}, // ｽ (Su)
    [0xBE] = {0x00, 0x0E, 0x11, 0x0E, 0x02, 0x0C, 0x00, 0x00}, // ｾ (Se)
    [0xBF] = {0x00, 0x04, 0x15, 0x0E, 0x04, 0x04, 0x00, 0x00}, // ｿ (So)

    // --- COLUMN 12 (0xC0 - 0xCF) : Katakana ---
    [0xC0] = {0x00, 0x08, 0x1C, 0x0A, 0x08, 0x08, 0x00, 0x00}, // ﾀ (Ta)
    [0xC1] = {0x00, 0x02, 0x1E, 0x02, 0x04, 0x08, 0x00, 0x00}, // ﾁ (Chi)
    [0xC2] = {0x00, 0x04, 0x15, 0x0E, 0x04, 0x04, 0x00, 0x00}, // ﾂ (Tsu)
    [0xC3] = {0x00, 0x02, 0x12, 0x12, 0x12, 0x0C, 0x00, 0x00}, // ﾃ (Te)
    [0xC4] = {0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00}, // ﾄ (To)
    [0xC5] = {0x00, 0x08, 0x08, 0x08, 0x18, 0x08, 0x00, 0x00}, // ﾅ (Na)
    [0xC6] = {0x00, 0x11, 0x11, 0x11, 0x11, 0x0E, 0x00, 0x00}, // ﾆ (Ni)
    [0xC7] = {0x00, 0x1E, 0x02, 0x04, 0x02, 0x1C, 0x00, 0x00}, // ﾇ (Nu)
    [0xC8] = {0x00, 0x08, 0x18, 0x0A, 0x0C, 0x08, 0x00, 0x00}, // ﾈ (Ne)
    [0xC9] = {0x00, 0x02, 0x04, 0x08, 0x10, 0x0E, 0x00, 0x00}, // ﾉ (No)
    [0xCA] = {0x00, 0x0A, 0x15, 0x15, 0x15, 0x0A, 0x00, 0x00}, // ﾊ (Ha)
    [0xCB] = {0x00, 0x02, 0x02, 0x1E, 0x04, 0x04, 0x00, 0x00}, // ﾋ (Hi)
    [0xCC] = {0x00, 0x1C, 0x08, 0x0C, 0x08, 0x1C, 0x00, 0x00}, // ﾌ (Fu)
    [0xCD] = {0x00, 0x02, 0x06, 0x0A, 0x12, 0x12, 0x00, 0x00}, // ﾍ (He)
    [0xCE] = {0x00, 0x12, 0x12, 0x12, 0x12, 0x0C, 0x00, 0x00}, // ﾎ (Ho)
    [0xCF] = {0x00, 0x0C, 0x0C, 0x0C, 0x04, 0x02, 0x00, 0x00}, // ﾏ (Ma)

    // --- COLUMN 13 (0xD0 - 0xDF) : Katakana & Marks ---
    [0xD0] = {0x00, 0x02, 0x12, 0x12, 0x12, 0x1C, 0x00, 0x00}, // ﾐ (Mi)
    [0xD1] = {0x00, 0x02, 0x0C, 0x14, 0x12, 0x11, 0x00, 0x00}, // ﾑ (Mu)
    [0xD2] = {0x00, 0x09, 0x11, 0x0E, 0x04, 0x02, 0x00, 0x00}, // ﾒ (Me)
    [0xD3] = {0x00, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x00, 0x00}, // ﾓ (Mo)
    [0xD4] = {0x00, 0x18, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00}, // ﾔ (Ya)
    [0xD5] = {0x00, 0x00, 0x12, 0x12, 0x12, 0x1C, 0x00, 0x00}, // ﾕ (Yu)
    [0xD6] = {0x00, 0x0E, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00}, // ﾖ (Yo)
    [0xD7] = {0x00, 0x12, 0x12, 0x12, 0x12, 0x12, 0x00, 0x00}, // ﾗ (Ra)
    [0xD8] = {0x00, 0x02, 0x02, 0x02, 0x02, 0x0C, 0x00, 0x00}, // ﾘ (Ri)
    [0xD9] = {0x00, 0x1B, 0x04, 0x04, 0x11, 0x0E, 0x00, 0x00}, // ﾙ (Ru)
    [0xDA] = {0x00, 0x0E, 0x11, 0x11, 0x11, 0x0A, 0x00, 0x00}, // ﾚ (Re)
    [0xDB] = {0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E, 0x00, 0x00}, // ﾛ (Ro)
    [0xDC] = {0x00, 0x00, 0x0C, 0x04, 0x04, 0x0C, 0x00, 0x00}, // ﾜ (Wa)
    [0xDD] = {0x00, 0x04, 0x0A, 0x11, 0x11, 0x01, 0x00, 0x00}, // ﾝ (N)
    [0xDE] = {0x00, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00}, // ﾞ (Dakuten / Voiced)
    [0xDF] = {0x00, 0x06, 0x09, 0x06, 0x00, 0x00, 0x00, 0x00}, // ﾟ (Handakuten / Semi-voiced)

    // --- COLUMN 14 (0xE0 - 0xEF) : Greek & Math ---
    [0xE0] = {0x00, 0x00, 0x0D, 0x12, 0x12, 0x12, 0x0D, 0x00}, // Alpha
    [0xE1] = {0x0A, 0x00, 0x0E, 0x01, 0x0F, 0x11, 0x0F, 0x00}, // a umlaut
    [0xE2] = {0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x1E, 0x10}, // Beta
    [0xE3] = {0x00, 0x00, 0x0E, 0x11, 0x1E, 0x10, 0x0E, 0x00}, // Epsilon
    [0xE4] = {0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x15, 0x18}, // Mu
    [0xE5] = {0x00, 0x00, 0x0E, 0x10, 0x0E, 0x01, 0x1E, 0x00}, // Sigma (small)
    [0xE6] = {0x00, 0x00, 0x0E, 0x11, 0x11, 0x0E, 0x10, 0x00}, // Rho
    [0xE7] = {0x00, 0x00, 0x0E, 0x11, 0x0F, 0x01, 0x0E, 0x00}, // g (small)
    [0xE8] = {0x01, 0x02, 0x04, 0x1F, 0x01, 0x01, 0x01, 0x00}, // Square Root
    [0xE9] = {0x06, 0x09, 0x09, 0x06, 0x00, 0x1E, 0x00, 0x00}, // Superscript -1
    [0xEA] = {0x00, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0C, 0x00}, // j
    [0xEB] = {0x02, 0x05, 0x02, 0x00, 0x11, 0x0A, 0x04, 0x00}, // Superscript x
    [0xEC] = {0x00, 0x04, 0x0E, 0x15, 0x15, 0x0E, 0x04, 0x00}, // Cent
    [0xED] = {0x00, 0x10, 0x08, 0x04, 0x02, 0x01, 0x00, 0x00}, // L (Script?)
    [0xEE] = {0x0D, 0x12, 0x00, 0x16, 0x19, 0x11, 0x11, 0x00}, // n tilde
    [0xEF] = {0x0A, 0x00, 0x0E, 0x11, 0x11, 0x11, 0x0E, 0x00}, // o umlaut

    // --- COLUMN 15 (0xF0 - 0xFF) : Math, Kanji, Blocks ---
    [0xF0] = {0x00, 0x00, 0x1E, 0x11, 0x1E, 0x10, 0x10, 0x00}, // p
    [0xF1] = {0x00, 0x00, 0x0D, 0x13, 0x0F, 0x01, 0x01, 0x00}, // q
    [0xF2] = {0x00, 0x00, 0x0E, 0x11, 0x0F, 0x01, 0x0E, 0x00}, // Theta
    [0xF3] = {0x00, 0x00, 0x0A, 0x15, 0x15, 0x0A, 0x00, 0x00}, // Infinity
    [0xF4] = {0x0E, 0x11, 0x11, 0x11, 0x0A, 0x0A, 0x1B, 0x00}, // Omega
    [0xF5] = {0x0A, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0D, 0x00}, // u umlaut
    [0xF6] = {0x1F, 0x10, 0x08, 0x04, 0x08, 0x10, 0x1F, 0x00}, // Sigma (Upper)
    [0xF7] = {0x1F, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x00}, // Pi
    [0xF8] = {0x1F, 0x00, 0x11, 0x0A, 0x04, 0x0A, 0x11, 0x00}, // x bar
    [0xF9] = {0x00, 0x00, 0x11, 0x11, 0x0F, 0x01, 0x0E, 0x00}, // y
    [0xFA] = {0x04, 0x1F, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00}, // 千 (Sen - Thousand)
    [0xFB] = {0x1F, 0x04, 0x08, 0x10, 0x10, 0x08, 0x06, 0x00}, // 万 (Man - Ten thousand)
    [0xFC] = {0x1F, 0x11, 0x1F, 0x04, 0x04, 0x04, 0x04, 0x00}, // 円 (Yen - Kanji form)
    [0xFD] = {0x04, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x04, 0x00}, // Divide
    [0xFE] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, // Blank
    [0xFF] = {0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x00}  // Block (Full)
};

// ============================================================================
//  CONSTRUCTOR
// ============================================================================
nhd_0216k1z::nhd_0216k1z() {
    // 1. Initialize Memory
    // Fill DDRAM with spaces (0x20)
    std::memset(m_ddram, 0x20, sizeof(m_ddram));
    // Clear CGRAM
    std::memset(m_cgram, 0x00, sizeof(m_cgram));
    
    // 2. Initialize Display Cache
    // We use a vector of strings to hold the UTF-8 renderable text
    m_display_cache.resize(2);
    m_display_cache[0] = "                "; // 16 spaces
    m_display_cache[1] = "                ";

    // 3. Defaults
    m_8bit_mode = true; // LCDs power up in 8-bit mode
    m_display_on = false;
    m_cursor_on = false;
    m_blink_on = false;
    m_increment = true;
    m_shift = false;
}

// ============================================================================
//  4-BIT INTERFACE (Matches Schematic)
// ============================================================================
void nhd_0216k1z::write_4bit(u8 data_lines, bool rs, bool rw, bool e) {
    // 1. Detect Falling Edge of E (High -> Low)
    if (m_prev_e && !e) {
        // Read the high nibble from the data lines (Bits 4-7)
        u8 nibble = data_lines & 0xF0; 

        if (m_8bit_mode) {
            // --- SPECIAL CASE: INITIALIZATION ---
            // When in 8-bit mode (power on), if we are wired for 4-bit,
            // we receive commands as single nibbles on the upper pins.
            
            // Function Set: Change to 4-bit mode (0x20)
            if (!rs && !rw && (nibble == 0x20)) {
                m_8bit_mode = false;
                m_nibble_flip = false; // Reset nibble tracker
            }
            // Function Set: 8-bit mode (0x30) - Used during "Wake Up"
            else if (!rs && !rw && (nibble == 0x30)) {
                // Do nothing, just stay in 8-bit mode. 
                // This is part of the "Wait... Reset... Wait" sequence.
                m_8bit_mode = true;
                m_nibble_flip = false;
            }
        }
        else {
            // --- NORMAL 4-BIT OPERATION ---
            if (!m_nibble_flip) {
                // First Nibble (High)
                m_high_nibble = nibble;
                m_nibble_flip = true;
            } 
            else {
                // Second Nibble (Low)
                // The data is on lines 7-4, so we shift it down to 3-0
                u8 low_nibble = (nibble >> 4);
                u8 full_byte = m_high_nibble | low_nibble;
                
                // Execute
                if (rs) write_data(full_byte);
                else    process_instruction(full_byte);
                
                m_nibble_flip = false; // Reset for next command
            }
        }
    }
    m_prev_e = e;
}

// ============================================================================
//  8-BIT INTERFACE
// ============================================================================
void nhd_0216k1z::write_8bit(u8 byte, bool rs, bool rw) {
    // Direct execution, no nibble assembly needed
    if (rs) write_data(byte);
    else    process_instruction(byte);
}

// ============================================================================
//  INSTRUCTION PROCESSOR (HD44780 Standard)
// ============================================================================
void nhd_0216k1z::process_instruction(u8 cmd) {
    
    // 1. CLEAR DISPLAY (0x01)
    if (cmd == 0x01) {
        std::memset(m_ddram, 0x20, sizeof(m_ddram));
        m_ac = 0;
        m_increment = true; 
    }
    
    // 2. RETURN HOME (0x02 - 0x03)
    else if ((cmd & 0xFE) == 0x02) {
        m_ac = 0;
    }
    
    // 3. ENTRY MODE SET (0x04 - 0x07)
    // Bit 1: I/D (Increment/Decrement)
    // Bit 0: S   (Shift)
    else if ((cmd & 0xFC) == 0x04) {
        m_increment = (cmd & 0x02);
        m_shift     = (cmd & 0x01);
    }
    
    // 4. DISPLAY CONTROL (0x08 - 0x0F)
    // Bit 2: D (Display On)
    // Bit 1: C (Cursor On)
    // Bit 0: B (Blink On)
    else if ((cmd & 0xF8) == 0x08) {
        m_display_on = (cmd & 0x04);
        m_cursor_on  = (cmd & 0x02);
        m_blink_on   = (cmd & 0x01);
    }
    
    // 5. CURSOR / DISPLAY SHIFT (0x10 - 0x1F)
    else if ((cmd & 0xF0) == 0x10) {
        bool sc = (cmd & 0x08); // Screen vs Cursor
        bool rl = (cmd & 0x04); // Right vs Left
        if (!sc) {
            // Move Cursor
            if (rl) m_ac++; else m_ac--;
        }
    }
    
    // 6. FUNCTION SET (0x20 - 0x3F)
    else if ((cmd & 0xE0) == 0x20) {
        m_8bit_mode = (cmd & 0x10);
        // We track lines/font but don't strictly enforce rendering limits here
    }
    
    // 7. SET CGRAM ADDRESS (0x40 - 0x7F)
    else if ((cmd & 0xC0) == 0x40) {
        m_ac = (cmd & 0x3F); 
    }
    
    // 8. SET DDRAM ADDRESS (0x80 - 0xFF)
    else if (cmd & 0x80) {
        m_ac = (cmd & 0x7F);
    }
    
    update_visuals();
}

// ============================================================================
//  DATA WRITE
// ============================================================================
void nhd_0216k1z::write_data(u8 data) {
    // Safety Wrap (80 bytes of RAM)
    if (m_ac >= 0x80) m_ac = 0; 
    
    m_ddram[m_ac] = data;
    
    // Increment / Decrement Cursor
    if (m_increment) m_ac++;
    else             m_ac--;
    
    update_visuals();
}

// ============================================================================
//  VISUAL UPDATE (Translation Layer)
// ============================================================================
void nhd_0216k1z::update_visuals() {
    // Rebuild the strings entirely because UTF-8 chars vary in byte length.
    
    // --- Line 1 (0x00 - 0x0F) ---
    m_display_cache[0].clear();
    for (int i = 0; i < 16; i++) {
        m_display_cache[0] += map_rom_code_to_utf8(m_ddram[0x00 + i]);
    }
    
    // --- Line 2 (0x40 - 0x4F) ---
    m_display_cache[1].clear();
    for (int i = 0; i < 16; i++) {
        m_display_cache[1] += map_rom_code_to_utf8(m_ddram[0x40 + i]);
    }
}

// ============================================================================
//  ROM CODE A00 MAPPING (From Table 4)
// ============================================================================
std::string nhd_0216k1z::map_rom_code_to_utf8(u8 b) {
    // 1. Standard ASCII (0x20 - 0x7D)
    // Note: 0x5C is Yen (¥) in A00 ROM, but Backslash (\) in ASCII.
    // We will use Yen to match the table provided.
    if (b >= 0x20 && b <= 0x7D) {
        if (b == 0x5C) return "¥"; 
        return std::string(1, (char)b);
    }

    // 2. Specific Symbols from Table 4
    switch (b) {
        // --- Special Symbols ---
        case 0x7E: return "→"; // Right Arrow
        case 0x7F: return "←"; // Left Arrow
        
        // --- Upper Symbols (Katakana / Greek / Math) ---
        case 0xA0: return " "; // Nbsp
        case 0xA1: return "｡";
        case 0xA2: return "｢";
        case 0xA3: return "｣";
        case 0xA4: return "､";
        case 0xA5: return "･";
        
        // Selected Greek/Math from bottom right of table
        case 0xDF: return "°"; // Degree
        case 0xE0: return "α"; // Alpha
        case 0xE2: return "β"; // Beta
        case 0xE3: return "ε"; // Epsilon
        case 0xE4: return "μ"; // Mu
        case 0xE5: return "σ"; // Sigma
        case 0xF2: return "θ"; // Theta
        case 0xF3: return "∞"; // Infinity
        case 0xF4: return "Ω"; // Omega
        case 0xF6: return "Σ"; // Sigma
        case 0xF7: return "π"; // Pi
        
        case 0xFD: return "÷"; // Divide
        case 0xFF: return "█"; // Black Block

        // 3. CGRAM (0x00 - 0x07) placeholder
        case 0x00: case 0x08: return " "; 
        
        default: return "."; // Unmapped characters show as dot
    }
}

const std::vector<std::string>& nhd_0216k1z::get_display_lines() {
    return m_display_cache;
}